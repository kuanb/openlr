<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>OpenLR</title>
    <meta name="description" content="OpenLR">
    <meta name="author" content="kuanbutts">

    <link rel="stylesheet" href="arrowstyle.css">
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #form { position: absolute; top: 15px; left: 15px; z-index: 1; }
        #form input { width: 200px; }
        #header { position: absolute; top: 15px; right: 15px; z-index: 1; background-color: white; }
        .mapboxgl-popup {
            max-width: 200px;
        }
        .mapboxgl-popup-content {
            text-align: center;
            font-family: 'Open Sans', sans-serif;
        }
    </style>

</head>

<body>

    <div id="form">
        <input type="text" id="openlrInput" name="openlrInput" placeholder="openlr string  here"></input>
        <button type="submit" onclick="process()">Submit</button>
    </div>

    <div id="map"></div>
    <div id="header">Purple is start node</div>

</body>

<script src="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/openlr-js@latest/lib/browser/bundle.min.js"></script>

<script type="text/javascript">
    mapboxgl.accessToken = 'pk.eyJ1Ijoia3VhbmIiLCJhIjoidXdWUVZ2USJ9.qNKXXP6z9_fKA8qrmpOi6Q';
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/streets-v11', // stylesheet location
        center: [-74.5, 40], // starting position [lng, lat]
        zoom: 1 // starting zoom
    });

    // CwNhbCU+jzPLAwD0/34zGw==
    // CwUVTSRzcRNIBQHJ/9MUfAAA
    // C/8G3CcQkht4FPrF/kAbbgv9G/66G2MbAA==

    function process() {
        try {
            const binaryDecoder = new OpenLR.BinaryDecoder();

            const openLrString = document.getElementById('openlrInput').value;
            const openLrBinary = OpenLR.Buffer.from(openLrString, 'base64');
            const locationReference = OpenLR.LocationReference.fromIdAndBuffer('binary', openLrBinary);
            const rawLocationReference = binaryDecoder.decodeData(locationReference);
            const jsonObject = OpenLR.Serializer.serialize(rawLocationReference);

            const coordsAndBearings = jsonObject.properties._points.properties.map(
                x => [x.properties._longitude, x.properties._latitude, x.properties._bearing]);
            const coords = coordsAndBearings.map(cab => [cab[0], cab[1]]);
            const geojson = {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': coords,
                },
            }

            if (map.getLayer("route")) {
                map.removeLayer("route");
            }

            if (map.getSource("route")) {
                map.removeSource("route");
            }

            map.addSource('route', {
                'type': 'geojson',
                'data': geojson,
            });
            map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': 'route',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#000',
                    'line-width': 8
                }
            });

            // add markers to map
            coordsAndBearings.forEach(cab => {
                const markerLoc = [cab[0], cab[1]];
                console.log(markerLoc)
                const bearingRaw = cab[2];
                const bearing = Math.round(bearingRaw);

                const el = document.createElement('div');
                el.className = `arrowmarker${bearing}`;

                // make a marker for each feature and add to the map
                new mapboxgl.Marker(el)
                    .setLngLat(markerLoc)
                    .setPopup(
                        new mapboxgl.Popup({ offset: 25 })
                            .setHTML(`<h3>Bearing:</h3><p>${bearingRaw}</p>`)
                    )
                    .addTo(map);
            });

            const coordinates = geojson.geometry.coordinates;
            const bounds = coordinates.reduce((bounds, coord) => {
                return bounds.extend(coord);
            }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
             
            map.fitBounds(bounds, { padding: 100 });

        } catch(error) {
            console.log(error);
        }

    }
</script>

</html>
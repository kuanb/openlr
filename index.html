<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>OpenLR</title>
    <meta name="description" content="OpenLR">
    <meta name="author" content="kuanbutts">

    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #form { position: absolute; top: 15px; left: 15px; z-index: 1; }
        #form input { width: 200px; }
        #header { position: absolute; top: 15px; right: 15px; z-index: 1; background-color: white; }
    </style>

</head>

<body>

    <div id="form">
        <input type="text" id="openlrInput" name="openlrInput" placeholder="openlr string  here"></input>
        <button type="submit" onclick="process()">Submit</button>
    </div>

    <div id="map"></div>
    <div id="header">Purple is start node</div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/openlr-js@latest/lib/browser/bundle.min.js"></script>

    <script type="text/javascript">
        mapboxgl.accessToken = 'pk.eyJ1Ijoia3VhbmIiLCJhIjoidXdWUVZ2USJ9.qNKXXP6z9_fKA8qrmpOi6Q';
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'mapbox://styles/mapbox/streets-v11', // stylesheet location
            center: [-74.5, 40], // starting position [lng, lat]
            zoom: 1 // starting zoom
        });

        // CwNhbCU+jzPLAwD0/34zGw==
        // CD0BEAA5OP8G3CcQkgAJBQQDA8AACgUEA4kdAP0b/roACQUEAwMaAHAB+sX+QAAJBQQDA3YACgUEA4U5ABsA
        // CCoBEAAmJf4A3yg78wAJBQQDA4AACgUEA4pkAPvB+/UACQUEAwMaADAAikg=
        // CD0BEAA5OP3kASjDJgAJBQQDA80ACgUEA/Q2APvUDEoACQUEAwN3AHABzHwiNAAJBQQDAwUACgUEA50TAAAA
        // CD0BEAA5OP8G3CcQkgAJBQQDA8AACgUEA4kdAP0b/roACQUEAwMaAHAB+sX+QAAJBQQDA3YACgUEA4U5ABsA

        function process() {
            try {
                const binaryDecoder = new OpenLR.BinaryDecoder();

                const openLrString = document.getElementById('openlrInput').value;
                const openLrBinary = OpenLR.Buffer.from(openLrString, 'base64');
                const locationReference = OpenLR.LocationReference.fromIdAndBuffer('binary', openLrBinary);
                const rawLocationReference = binaryDecoder.decodeData(locationReference);
                const jsonObject = OpenLR.Serializer.serialize(rawLocationReference);

                const coords = jsonObject.properties._points.properties.map(x => [x.properties._longitude, x.properties._latitude]);
                const geojson = {
                    'type': 'Feature',
                    'properties': {},
                    'geometry': {
                        'type': 'LineString',
                        'coordinates': coords,
                    },
                }

                if (map.getLayer("route")) {
                    map.removeLayer("route");
                }

                if (map.getSource("route")) {
                    map.removeSource("route");
                }

                map.addSource('route', {
                    'type': 'geojson',
                    'data': geojson,
                });
                map.addLayer({
                    'id': 'route',
                    'type': 'line',
                    'source': 'route',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': '#FF0000',
                        'line-width': 8
                    }
                });

                const geojsonstart = {
                    'type': 'Feature',
                    'properties': {},
                    'geometry': {
                        'type': 'Point',
                        'coordinates': coords[0],
                    },
                }

                if (map.getLayer("start")) {
                    map.removeLayer("start");
                }

                if (map.getSource("start")) {
                    map.removeSource("start");
                }

                map.addSource('start', {
                    'type': 'geojson',
                    'data': geojsonstart,
                });
                map.addLayer({
                    'id': 'start',
                    'type': 'circle',
                    'source': 'start',
                    'paint': {
                        'circle-radius': 10,
                        'circle-color': 'purple',
                    }
                });

                const coordinates = geojson.geometry.coordinates;
                console.log('coordinates', coordinates);
                const bounds = coordinates.reduce((bounds, coord) => {
                    return bounds.extend(coord);
                }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
                 
                map.fitBounds(bounds, { padding: 100 });

            } catch(error) {
                console.log(error);
            }

        }
    </script>

</body>

</html>